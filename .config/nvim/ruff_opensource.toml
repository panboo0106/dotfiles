# ========================================
# Ruff 配置文件 - 开源最佳实践版本
# ========================================
# 遵循 2025 年开源社区最佳实践
# 参考：Google Python Style Guide, PEP 8, Flask/Django/pytest 项目
#
# 适用场景：
# - 开源项目
# - 个人项目
# - 国际化团队
# - 追求最佳实践的团队
#
# 官方文档: https://docs.astral.sh/ruff/configuration/
# 最佳实践: https://pydevtools.com/handbook/how-to/how-to-configure-recommended-ruff-defaults/

# ========================================
# 基础设置（开源标准）
# ========================================
line-length = 88                   # Black 默认值（开源标准）
target-version = "py311"           # 推荐使用较新的 Python 版本
indent-width = 4                   # 缩进宽度

# 文件包含模式
include = ["*.py", "*.pyi", "*.ipynb", "pyproject.toml"]

# 排除目录
exclude = [
  ".bzr",
  ".direnv",
  ".eggs",
  ".git",
  ".git-rewrite",
  ".hg",
  ".ipynb_checkpoints",
  ".mypy_cache",
  ".nox",
  ".pants.d",
  ".pyenv",
  ".pytest_cache",
  ".pytype",
  ".ruff_cache",
  ".svn",
  ".tox",
  ".venv",
  ".vscode",
  "__pypackages__",
  "_build",
  "buck-out",
  "build",
  "dist",
  "node_modules",
  "site-packages",
  "venv",
]

# 启用 preview 模式（2025 最佳实践）
preview = true

[lint]
explicit-preview-rules = true
# ========================================
# 规则选择（开源最佳实践）
# ========================================
# 策略：启用所有规则，但保留更多灵活性
select = [
  "ALL",  # 启用所有规则
]

# ========================================
# 忽略规则（开源社区常见例外）
# ========================================
ignore = [
  # ========== 与格式化工具冲突 ==========
  "E203",      # 空格在 slice 周围（与 Black 冲突）
  "E501",      # 行长度由 formatter 处理
  "ISC001",    # 单行隐式字符串连接

  # ========== 开源社区常见例外 ==========
  "PLR0911",   # 过多返回语句（有时合理）
  "PLR0913",   # 过多函数参数（有时合理）
  "PLR2004",   # 魔术常量（测试中常见）
  "TRY003",    # 异常消息过长（有时需要详细说明）

  # ========== 性能和可读性权衡 ==========
  "PERF203",   # 可变对象性能建议
  "SIM108",    # 三元表达式（有时 if-else 更清晰）

  # ========== 文档字符串（宽松要求）==========
  "D100",      # 缺失模块文档字符串（建议添加）
  "D101",      # 缺失类文档字符串（建议添加）
  "D102",      # 缺失方法文档字符串（建议添加）
  "D103",      # 缺失函数文档字符串（建议添加）
  "D104",      # 缺失包文档字符串（建议添加）
  "D105",      # 缺失魔术方法文档字符串
  "D106",      # 缺失嵌套类文档字符串
  "D107",      # 缺失 __init__ 文档字符串

  # ========== 文档字符串风格冲突 ==========
  "D203",      # 与 D211 冲突，选择 D211
  "D212",      # 与 D213 冲突，选择 D213

  # ========== 类型注解（渐进式采用）==========
  "ANN001",    # 缺失参数类型注解
  "ANN002",    # 缺失返回值类型注解
  "ANN003",    # 缺失变量类型注解
  "ANN201",    # 缺失返回值类型注解
  "ANN204",    # 缺失返回值类型注解（特殊方法）

  # ========== TODO 和注释格式 ==========
  "TD002",     # TODO 作者格式
  "TD003",     # TODO 问题链接
  "FIX002",    # TODO 格式

  # ========== 社区常用模式 ==========
  "S101",      # 使用 assert（常见于测试）
  "S105",      # 硬编码密码（误报多）
  "S106",      # 硬编码密码（误报多）
  "S107",      # 硬编码密码（误报多）
  "S603",      # subprocess shell=True（有时需要）
]

# ========================================
# 自动修复配置
# ========================================
fixable = ["ALL"]
unfixable = []

# ========================================
# 每个文件的忽略规则（开源项目常见）
# ========================================
[lint.per-file-ignores]

# __init__.py 通常只用于导出
"__init__.py" = [
  "F401",      # 允许未使用的导入（用于 __all__）
  "E402",      # 允许非顶层导入
]

# 测试文件
"test_*.py" = [
  "S101",      # 测试中允许 assert
  "ANN",       # 测试中不强制类型注解
  "D",         # 测试中不强制文档字符串
  "PLR2004",   # 测试中允许魔术常量
]

"tests/**/*.py" = [
  "S101",      # 测试中允许 assert
  "ANN",       # 测试中不强制类型注解
  "D",         # 测试中不强制文档字符串
  "PLR2004",   # 测试中允许魔术常量
]

# 文档和示例文件
"docs/**/*.py" = [
  "ANN",       # 文档中不强制类型注解
  "D",         # 文档中不强制文档字符串
]

"examples/**/*.py" = [
  "ANN",       # 示例中不强制类型注解
  "D",         # 示例中不强制文档字符串
]

# Jupyter Notebook
"*.ipynb" = [
  "D",         # notebook 不强制文档字符串
  "E402",      # notebook 允许非顶层导入
  "I002",      # notebook 允许未排序的导入
]

# 脚本文件
"scripts/*" = [
  "D",         # 脚本不强制文档字符串
]

# ========================================
# McCabe 复杂度设置（开源标准）
# ========================================
[lint.mccabe]
max-complexity = 18  # 开源项目更宽松（建议：15-20）

# ========================================
# 格式化设置（与 Black 兼容）
# ========================================
[format]
quote-style = "double"           # 使用双引号
indent-style = "space"           # 使用空格缩进
line-ending = "auto"             # 自动检测行尾
skip-magic-trailing-comma = false  # 与 Black 一致
docstring-code-format = true     # 格式化文档字符串中的代码
docstring-code-line-length = "dynamic"  # 动态行长度

# ========================================
# isort 导入排序（开源项目标准）
# ========================================
[lint.isort]
known-first-party = []           # 根据项目调整
known-third-party = [
  "numpy",
  "pandas",
  "requests",
  "pytest",
  "django",
  "flask",
]
section-order = [
  "future",
  "standard-library",
  "third-party",
  "first-party",
  "local-folder",
]
combine-as-imports = true        # 合并 from 导入
split-on-trailing-comma = false
lines-after-imports = 2          # PEP 8 推荐

# ========================================
# pydocstyle 文档字符串（开源推荐）
# ========================================
[lint.pydocstyle]
convention = "google"           # Google 风格（推荐）
# 可选：numpy（科学计算）、pep257（基础）
ignore-decorators = ["property", "setter", "classmethod"]

# ========================================
# flake8-quotes 引号设置
# ========================================
[lint.flake8-quotes]
docstring-quotes = "double"      # 文档字符串使用双引号
inline-quotes = "double"         # 代码中使用双引号

# ========================================
# Pylint 设置（开源项目标准）
# ========================================
[lint.pylint]
max-args = 9                    # 函数最大参数（开源宽松）
max-returns = 6                 # 函数最大返回值（开源宽松）
max-statements = 61             # 函数最大语句数（开源宽松）
max-branches = 15
max-locals = 18
allow-magic-value-types = ["int", "float", "str", "bytes"]

# ========================================
# flake8-bugbear 框架支持
# ========================================
[lint.flake8-bugbear]
extend-immutable-calls = [
  "fastapi.Depends",
  "fastapi.Query",
  "fastapi.Path",
  "fastapi.Body",
  "typer.Argument",
  "typer.Option",
  "click.confirm",
]

# ========================================
# pyupgrade 语法升级（开源推荐）
# ========================================
[lint.pyupgrade]
keep-runtime-typing = false     # 移除运行时类型注解（Python 3.11+）

# ========================================
# pycodestyle PEP 8
# ========================================
[lint.pycodestyle]
max-line-length = 88            # Black 默认值

# ========================================
# pep8-naming 命名约定
# ========================================
[lint.pep8-naming]
classmethod-decorators = [
  "classmethod",
  "pydantic.validator",
  "pydantic.field_validator",
  "staticmethod",
  "declarative_mixin",
]
ignore-names = [
  "test_*",
  "setup_*",
  "teardown_*",
  "setUp",
  "tearDown",
]

# ========================================
# flake8-type-checking 类型检查（开源推荐）
# ========================================
[lint.flake8-type-checking]
strict = true
runtime-evaluated-base-classes = [
  "pydantic.BaseModel",
  "sqlalchemy.orm.DeclarativeBase",
  "typing.TypedDict",
]

# ========================================
# flake8-pytest-style 测试
# ========================================
[lint.flake8-pytest-style]
mark-parentheses = false        # 不强制括号

# ========================================
# flake8-bandit 安全检查（开源推荐）
# ========================================
# 注：安全检查已在 select = ["ALL"] 中包含（S 系列）

# ========================================
# 其他设置
# ========================================
# 注意: dummy-variable-rgx 已在 Ruff 新版本中移除，未使用变量默认警告

# ========================================
# 使用说明（开源最佳实践）
# ========================================
# 开源项目检查命令：
#
# 1. 完整检查：
#    ruff check --config ruff_opensource.toml .
#
# 2. 自动修复：
#    ruff check --config ruff_opensource.toml --fix .
#
# 3. 格式化：
#    ruff format --config ruff_opensource.toml .
#
# 4. 只检查错误（忽略警告）：
#    ruff check --config ruff_opensource.toml --select F,E,W .
#
# 5. CI/CD 集成（GitHub Actions）：
#    ruff check --config ruff_opensource.toml --output-format=github
#
# 6. Pre-commit 集成：
#    - repo: https://github.com/astral-sh/ruff-pre-commit
#      rev: v0.1.0
#      hooks:
#        - id: ruff
#          args: [--config, ruff_opensource.toml, --fix]
#        - id: ruff-format
#          args: [--config, ruff_opensource.toml]
#
# ========================================
# 与公司版本的主要区别
# ========================================
# 1. 行长度：88 vs 120
# 2. Python 版本：py311 vs py39
# 3. 复杂度：18 vs 15
# 4. 函数返回值：6 vs 3（更宽松）
# 5. 函数参数：9 vs 7（更宽松）
# 6. 类型注解：渐进式 vs 建议性
# 7. 忽略规则：更多开源社区常见例外
# 8. 安全检查：部分放宽（S105-S107）
# 9. 文档字符串：要求更宽松
# 10. 适合国际化团队（不强制中文支持）
