#!/bin/bash
# Pre-commit Hook - å¤šè¯­è¨€ä»£ç æ£€æŸ¥
# æ”¯æŒ: JavaScript, C++, Shell, Python, Go
# åŸºäº SFRD-PPQA-03-6.7 ç¼–ç è§„èŒƒ

set -e

echo "ğŸ” è¿è¡Œ Pre-commit æ£€æŸ¥..."

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# è·å–æš‚å­˜çš„æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«æš‚å­˜
if [ -z "$STAGED_FILES" ]; then
    echo "âš ï¸  æ²¡æœ‰æš‚å­˜çš„æ–‡ä»¶"
    exit 0
fi

echo "æš‚å­˜çš„æ–‡ä»¶:"
echo "$STAGED_FILES"
echo ""

# ============ JavaScript æ£€æŸ¥ ============
check_javascript() {
    local js_files=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx)$' || true)

    if [ -n "$js_files" ]; then
        echo -e "${YELLOW}ğŸ“ æ£€æŸ¥ JavaScript æ–‡ä»¶...${NC}"

        for file in $js_files; do
            if [ -f "$file" ]; then
                echo "  æ£€æŸ¥ $file"

                # ESLint æ£€æŸ¥
                if command -v eslint >/dev/null 2>&1; then
                    if ! eslint "$file" 2>/dev/null; then
                        echo -e "${RED}âŒ ESLint æ£€æŸ¥å¤±è´¥: $file${NC}"
                        echo "è¯·è¿è¡Œ: make js-lint æˆ– npm run lint"
                        return 1
                    fi
                fi

                # Prettier æ ¼å¼æ£€æŸ¥
                if command -v prettier >/dev/null 2>&1; then
                    if ! prettier --check "$file" >/dev/null 2>&1; then
                        echo -e "${YELLOW}âš ï¸  $file éœ€è¦æ ¼å¼åŒ–${NC}"
                        echo "è¯·è¿è¡Œ: make js-format æˆ– npm run format"
                        # ä¸é˜»æ­¢æäº¤ï¼Œåªè­¦å‘Š
                    fi
                fi
            fi
        done
    fi
}

# ============ C++ æ£€æŸ¥ ============
check_cpp() {
    local cpp_files=$(echo "$STAGED_FILES" | grep -E '\.(cpp|cc|h|hpp)$' || true)

    if [ -n "$cpp_files" ]; then
        echo -e "${YELLOW}ğŸ“ æ£€æŸ¥ C++ æ–‡ä»¶...${NC}"

        for file in $cpp_files; do
            if [ -f "$file" ]; then
                echo "  æ£€æŸ¥ $file"

                # clang-format æ ¼å¼æ£€æŸ¥
                if command -v clang-format >/dev/null 2>&1; then
                    if ! clang-format --dry-run --Werror "$file" >/dev/null 2>&1; then
                        echo -e "${YELLOW}âš ï¸  $file éœ€è¦æ ¼å¼åŒ–${NC}"
                        echo "è¯·è¿è¡Œ: make cpp-format"
                        # ä¸é˜»æ­¢æäº¤ï¼Œåªè­¦å‘Š
                    fi
                fi

                # clang-tidy æ£€æŸ¥ï¼ˆå¯é€‰ï¼Œå› ä¸ºå¯èƒ½è¾ƒæ…¢ï¼‰
                if [ "$ENABLE_CLANG_TIDY" = "true" ]; then
                    if command -v clang-tidy >/dev/null 2>&1; then
                        if ! clang-tidy "$file" --config-file="$HOME/.config/nvim/.clang-tidy" >/dev/null 2>&1; then
                            echo -e "${RED}âŒ clang-tidy æ£€æŸ¥å¤±è´¥: $file${NC}"
                            echo "è¯·è¿è¡Œ: make cpp-lint"
                            return 1
                        fi
                    fi
                fi
            fi
        done
    fi
}

# ============ Shell æ£€æŸ¥ ============
check_shell() {
    local sh_files=$(echo "$STAGED_FILES" | grep -E '\.(sh|bash)$' || true)

    if [ -n "$sh_files" ]; then
        echo -e "${YELLOW}ğŸ“ æ£€æŸ¥ Shell è„šæœ¬...${NC}"

        for file in $sh_files; do
            if [ -f "$file" ]; then
                echo "  æ£€æŸ¥ $file"

                # ShellCheck æ£€æŸ¥
                if command -v shellcheck >/dev/null 2>&1; then
                    if ! shellcheck "$file" 2>/dev/null; then
                        echo -e "${RED}âŒ ShellCheck æ£€æŸ¥å¤±è´¥: $file${NC}"
                        echo "è¯·è¿è¡Œ: make sh-lint"
                        return 1
                    fi
                fi

                # shfmt æ ¼å¼æ£€æŸ¥
                if command -v shfmt >/dev/null 2>&1; then
                    if ! shfmt -l "$file" >/dev/null 2>&1; then
                        echo -e "${YELLOW}âš ï¸  $file éœ€è¦æ ¼å¼åŒ–${NC}"
                        echo "è¯·è¿è¡Œ: make sh-format"
                        # ä¸é˜»æ­¢æäº¤ï¼Œåªè­¦å‘Š
                    fi
                fi
            fi
        done
    fi
}

# ============ Python æ£€æŸ¥ ============
check_python() {
    local py_files=$(echo "$STAGED_FILES" | grep -E '\.py$' || true)

    if [ -n "$py_files" ]; then
        echo -e "${YELLOW}ğŸ“ æ£€æŸ¥ Python æ–‡ä»¶...${NC}"

        for file in $py_files; do
            if [ -f "$file" ]; then
                echo "  æ£€æŸ¥ $file"

                # Ruff æ£€æŸ¥
                if command -v ruff >/dev/null 2>&1; then
                    if ! ruff check --config="$HOME/.config/nvim/ruff_company.toml" "$file" 2>/dev/null; then
                        echo -e "${RED}âŒ Ruff æ£€æŸ¥å¤±è´¥: $file${NC}"
                        echo "è¯·è¿è¡Œ: make py-lint"
                        return 1
                    fi
                fi

                # Ruff æ ¼å¼æ£€æŸ¥
                if command -v ruff >/dev/null 2>&1; then
                    if ! ruff format --check --config="$HOME/.config/nvim/ruff_company.toml" "$file" >/dev/null 2>&1; then
                        echo -e "${YELLOW}âš ï¸  $file éœ€è¦æ ¼å¼åŒ–${NC}"
                        echo "è¯·è¿è¡Œ: make py-format"
                        # ä¸é˜»æ­¢æäº¤ï¼Œåªè­¦å‘Š
                    fi
                fi
            fi
        done
    fi
}

# ============ Go æ£€æŸ¥ ============
check_go() {
    local go_files=$(echo "$STAGED_FILES" | grep -E '\.go$' || true)

    if [ -n "$go_files" ]; then
        echo -e "${YELLOW}ğŸ“ æ£€æŸ¥ Go æ–‡ä»¶...${NC}"

        for file in $go_files; do
            if [ -f "$file" ]; then
                echo "  æ£€æŸ¥ $file"

                # gofmt æ ¼å¼æ£€æŸ¥
                if command -v gofmt >/dev/null 2>&1; then
                    if ! gofmt -l "$file" >/dev/null 2>&1; then
                        echo -e "${YELLOW}âš ï¸  $file éœ€è¦æ ¼å¼åŒ–${NC}"
                        echo "è¯·è¿è¡Œ: make go-format"
                        # ä¸é˜»æ­¢æäº¤ï¼Œåªè­¦å‘Š
                    fi
                fi
            fi
        done
    fi
}

# ============ ç¼–ç æ£€æŸ¥ ============
check_encoding() {
    echo -e "${YELLOW}ğŸ“ æ£€æŸ¥æ–‡ä»¶ç¼–ç ...${NC}"

    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            # æ£€æŸ¥æ–‡ä»¶ç¼–ç 
            encoding=$(file --mime-encoding "$file" 2>/dev/null | awk '{print $2}')
            if [ "$encoding" != "utf-8" ] && [ "$encoding" != "us-ascii" ]; then
                echo -e "${RED}âŒ æ–‡ä»¶ç¼–ç é”™è¯¯: $file (${encoding})${NC}"
                echo "è¯·ç¡®ä¿æ–‡ä»¶ä¸º UTF-8 ç¼–ç "
                return 1
            fi

            # æ£€æŸ¥æ˜¯å¦æœ‰BOM
            if [ "$encoding" = "utf-8" ]; then
                if file "$file" | grep -q "UTF-8 (with BOM)"; then
                    echo -e "${YELLOW}âš ï¸  $file åŒ…å« BOMï¼Œå»ºè®®ç§»é™¤${NC}"
                fi
            fi
        fi
    done

    echo -e "${GREEN}âœ… æ–‡ä»¶ç¼–ç æ£€æŸ¥é€šè¿‡${NC}"
}

# ============ ä¸»æµç¨‹ ============
main() {
    # æ£€æŸ¥æ–‡ä»¶ç¼–ç 
    check_encoding

    # æ£€æŸ¥å„ç§è¯­è¨€
    check_javascript
    check_cpp
    check_shell
    check_python
    check_go

    echo ""
    echo -e "${GREEN}âœ… Pre-commit æ£€æŸ¥é€šè¿‡ï¼${NC}"
    echo ""
    echo "ğŸ“Œ æç¤º: æŸäº›æ ¼å¼é—®é¢˜åªä½œäº†è­¦å‘Šï¼Œä¸å½±å“æäº¤"
    echo "ğŸ“Œ å»ºè®®åœ¨æ¨é€å‰è¿è¡Œ make all è¿›è¡Œå®Œæ•´æ£€æŸ¥"
}

# è¿è¡Œä¸»æµç¨‹
main
