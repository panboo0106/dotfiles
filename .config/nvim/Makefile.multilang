# Makefile - å¤šè¯­è¨€é¡¹ç›®ç»Ÿä¸€å¼€å‘å‘½ä»¤
# æ”¯æŒ: JavaScript, C++, Shell, Python, Go
# åŸºäº SFRD-PPQA-03-6.7 ç¼–ç è§„èŒƒ

.PHONY: help all clean
.PHONY: js-lint js-format js-verify
.PHONY: cpp-lint cpp-format cpp-verify
.PHONY: sh-lint sh-format sh-verify
.PHONY: py-lint py-format py-verify
.PHONY: go-lint go-format go-verify

# é»˜è®¤ç›®æ ‡ï¼šæ˜¾ç¤ºå¸®åŠ©
help:
	@echo "=========================================="
	@echo "  SANGFOR å¤šè¯­è¨€å¼€å‘å‘½ä»¤"
	@echo "=========================================="
	@echo ""
	@echo "JavaScript:"
	@echo "  make js-lint      - ESLint æ£€æŸ¥"
	@echo "  make js-format    - Prettier æ ¼å¼åŒ–"
	@echo "  make js-verify    - å®Œæ•´éªŒè¯"
	@echo ""
	@echo "C++:"
	@echo "  make cpp-lint     - clang-tidy æ£€æŸ¥"
	@echo "  make cpp-format   - clang-format æ ¼å¼åŒ–"
	@echo "  make cpp-verify   - å®Œæ•´éªŒè¯"
	@echo ""
	@echo "Shell:"
	@echo "  make sh-lint      - ShellCheck æ£€æŸ¥"
	@echo "  make sh-format    - shfmt æ ¼å¼åŒ–"
	@echo "  make sh-verify    - å®Œæ•´éªŒè¯"
	@echo ""
	@echo "Python:"
	@echo "  make py-lint      - Ruff + Pylint æ£€æŸ¥"
	@echo "  make py-format    - Ruff æ ¼å¼åŒ–"
	@echo "  make py-verify    - å®Œæ•´éªŒè¯"
	@echo ""
	@echo "Go:"
	@echo "  make go-lint      - golangci-lint æ£€æŸ¥"
	@echo "  make go-format    - gofmt æ ¼å¼åŒ–"
	@echo "  make go-verify    - å®Œæ•´éªŒè¯"
	@echo ""
	@echo "é€šç”¨:"
	@echo "  make all          - æ£€æŸ¥æ‰€æœ‰è¯­è¨€"
	@echo "  make clean        - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo ""

# ============================================
# JavaScript (ESLint + Prettier)
# ============================================
JS_FILES := $(shell find . -name "*.js" -o -name "*.jsx" -not -path "*/node_modules/*" 2>/dev/null)

js-lint:
	@echo "ğŸ” è¿è¡Œ ESLint æ£€æŸ¥..."
	@if command -v eslint >/dev/null 2>&1; then \
		eslint . --ext .js,.jsx; \
	else \
		echo "âš ï¸  ESLint æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: npm install -g eslint"; \
	fi

js-format:
	@echo "ğŸ¨ ä½¿ç”¨ Prettier æ ¼å¼åŒ– JavaScript..."
	@if command -v prettier >/dev/null 2>&1; then \
		prettier --write "**/*.{js,jsx}"; \
	else \
		echo "âš ï¸  Prettier æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: npm install -g prettier"; \
	fi

js-verify: js-format js-lint
	@echo "âœ… JavaScript éªŒè¯é€šè¿‡"
	@echo ""
	@echo "âš ï¸  éœ€äººå·¥å®¡æŸ¥é¡¹ç›®:"
	@echo "  - æ–‡ä»¶å¤´éƒ¨æ³¨é‡Šï¼ˆchecklist 1.3ï¼‰"
	@echo "  - å‚æ•°éªŒè¯é€»è¾‘ï¼ˆchecklist 2.2ï¼‰"
	@echo "  - å‘½åç©ºé—´è§„èŒƒï¼ˆchecklist 3.5ï¼‰"
	@echo "  - å±æ€§ä¿®æ”¹æ¥å£ï¼ˆchecklist 3.3ï¼‰"

# ============================================
# C++ (clang-tidy + clang-format)
# ============================================
CPP_FILES := $(shell find . -name "*.cpp" -o -name "*.cc" -o -name "*.h" -o -name "*.hpp" 2>/dev/null)

cpp-lint:
	@echo "ğŸ” è¿è¡Œ clang-tidy æ£€æŸ¥..."
	@if command -v clang-tidy >/dev/null 2>&1; then \
		find . -name "*.cpp" -o -name "*.cc" -o -name "*.h" -o -name "*.hpp" | \
			xargs clang-tidy --config-file=$(HOME)/.config/nvim/.clang-tidy 2>/dev/null || true; \
	else \
		echo "âš ï¸  clang-tidy æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: brew install clang-tidy"; \
	fi

cpp-format:
	@echo "ğŸ¨ ä½¿ç”¨ clang-format æ ¼å¼åŒ– C++..."
	@if command -v clang-format >/dev/null 2>&1; then \
		find . -name "*.cpp" -o -name "*.cc" -o -name "*.h" -o -name "*.hpp" | \
			xargs clang-format -i -style=file; \
	else \
		echo "âš ï¸  clang-format æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: brew install clang-format"; \
	fi

cpp-verify: cpp-format cpp-lint
	@echo "âœ… C++ éªŒè¯é€šè¿‡"
	@echo ""
	@echo "âš ï¸  éœ€äººå·¥å®¡æŸ¥é¡¹ç›®:"
	@echo "  - å…¨å±€å˜é‡ä¾èµ–æ€§ï¼ˆchecklist 1.7ï¼‰"
	@echo "  - å¼‚å¸¸ä½¿ç”¨ç­–ç•¥ï¼ˆchecklist 2.1-2.3ï¼‰"
	@echo "  - ç±»æˆå‘˜è®¿é—®æƒé™ï¼ˆchecklist 1.9ï¼‰"
	@echo "  - è¿ç®—ç¬¦é‡è½½è¯­ä¹‰ï¼ˆchecklist 5.1ï¼‰"
	@echo "  - å®¹å™¨é€‰æ‹©ï¼ˆchecklist 6.4ï¼‰"

# ============================================
# Shell (ShellCheck + shfmt)
# ============================================
SH_FILES := $(shell find . -name "*.sh" -o -name "*.bash" 2>/dev/null)

sh-lint:
	@echo "ğŸ” è¿è¡Œ ShellCheck æ£€æŸ¥..."
	@if command -v shellcheck >/dev/null 2>&1; then \
		find . -name "*.sh" -exec shellcheck {} \; ; \
	else \
		echo "âš ï¸  ShellCheck æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: brew install shellcheck"; \
	fi

sh-format:
	@echo "ğŸ¨ ä½¿ç”¨ shfmt æ ¼å¼åŒ– Shell..."
	@if command -v shfmt >/dev/null 2>&1; then \
		find . -name "*.sh" -exec shfmt -w {} \; ; \
	else \
		echo "âš ï¸  shfmt æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: brew install shfmt"; \
	fi

sh-verify: sh-format sh-lint
	@echo "âœ… Shell éªŒè¯é€šè¿‡"
	@echo ""
	@echo "âš ï¸  éœ€äººå·¥å®¡æŸ¥é¡¹ç›®:"
	@echo "  - å‘½åè§„èŒƒï¼ˆchecklist 1.1ï¼‰"
	@echo "  - æ³¨é‡Šå®Œæ•´æ€§ï¼ˆchecklist 1.3ï¼‰"
	@echo "  - å‚æ•°éªŒè¯é€»è¾‘ï¼ˆchecklist 2.1ï¼‰"
	@echo "  - æ•°æ®éªŒè¯é€»è¾‘ï¼ˆchecklist 2.2ï¼‰"
	@echo "  - ç®¡é“æ“ä½œå®‰å…¨ï¼ˆchecklist 3.4ï¼‰"
	@echo "  - æ³¨å…¥æ”»å‡»é˜²æŠ¤ï¼ˆchecklist 3.6ï¼‰"

# ============================================
# Python (Ruff + Pylint)
# ============================================
py-lint:
	@echo "ğŸ” è¿è¡Œ Ruff æ£€æŸ¥..."
	@if command -v ruff >/dev/null 2>&1; then \
		ruff check --config=$(HOME)/.config/nvim/ruff_company.toml .; \
	else \
		echo "âš ï¸  Ruff æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: pip install ruff"; \
	fi
	@echo ""
	@echo "ğŸ” è¿è¡Œ Pylint æ£€æŸ¥..."
	@if command -v pylint >/dev/null 2>&1; then \
		pylint --rcfile=$(HOME)/.config/nvim/.pylintrc . 2>/dev/null || true; \
	else \
		echo "âš ï¸  Pylint æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: pip install pylint"; \
	fi

py-format:
	@echo "ğŸ¨ ä½¿ç”¨ Ruff æ ¼å¼åŒ– Python..."
	@if command -v ruff >/dev/null 2>&1; then \
		ruff format --config=$(HOME)/.config/nvim/ruff_company.toml .; \
	else \
		echo "âš ï¸  Ruff æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: pip install ruff"; \
	fi

py-verify: py-format py-lint
	@echo "âœ… Python éªŒè¯é€šè¿‡"
	@echo ""
	@echo "âš ï¸  éœ€äººå·¥å®¡æŸ¥é¡¹ç›®:"
	@echo "  - é—­åŒ…å˜é‡ç»‘å®šï¼ˆchecklist 3.9ï¼‰"
	@echo "  - åµŒå¥—ç±»ä½¿ç”¨ï¼ˆchecklist 3.8ï¼‰"
	@echo "  - åç¨‹å›æ”¶ï¼ˆchecklist 5.1ï¼‰"
	@echo "  - æ–‡ä»¶åˆ·æ–°æ—¶æœºï¼ˆchecklist 5.3ï¼‰"
	@echo "  - ç¡¬ç¼–ç æ£€æŸ¥ï¼ˆchecklist 7.2ï¼‰"

# ============================================
# Go (golangci-lint + gofmt)
# ============================================
go-lint:
	@echo "ğŸ” è¿è¡Œ golangci-lint æ£€æŸ¥..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run --config=$(HOME)/.config/nvim/.golangci.yml; \
	else \
		echo "âš ï¸  golangci-lint æœªå®‰è£…ï¼Œè¯·å‚è€ƒGoæ–‡æ¡£å®‰è£…"; \
	fi

go-format:
	@echo "ğŸ¨ ä½¿ç”¨ gofmt æ ¼å¼åŒ– Go..."
	@if command -v gofmt >/dev/null 2>&1; then \
		gofmt -w -s .; \
	else \
		echo "âš ï¸  gofmt æœªå®‰è£…"; \
	fi

go-verify: go-format go-lint
	@echo "âœ… Go éªŒè¯é€šè¿‡"

# ============================================
# é€šç”¨å‘½ä»¤
# ============================================
all: js-verify cpp-verify sh-verify py-verify go-verify
	@echo ""
	@echo "=========================================="
	@echo "âœ… æ‰€æœ‰è¯­è¨€éªŒè¯å®Œæˆï¼"
	@echo "=========================================="

clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	@# JavaScript
	@find . -name "*.log" -delete 2>/dev/null || true
	@rm -rf node_modules/.cache 2>/dev/null || true
	@# C++
	@find . -name "*.o" -delete 2>/dev/null || true
	@find . -name "*.so" -delete 2>/dev/null || true
	@rm -rf build/ cmake-build-*/ 2>/dev/null || true
	@# Python
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@rm -rf .mypy_cache .pytest_cache .ruff_cache 2>/dev/null || true
	@# Go
	@rm -rf vendor 2>/dev/null || true
	@# Shell
	@find . -name "*.sh.bak" -delete 2>/dev/null || true
	@find . -name "*~" -delete 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"
