# ========================================
# Ruff 配置文件 (2025 最佳实践 + 公司编码规范)
# ========================================
# 本配置文件基于公司编码规范 checklist 生成，涵盖：
# - 01. style - 风格规范
# - 02. exception - 错误处理
# - 03. func - 函数/方法
# - 04. language - 语言特性
# - 05. concurrent - 并发
# - 06. i18n - 国际化
# - 07. security - 安全特性
# - 08. third_party_library - 第三方库
# - 09. tools - 工具检查
#
# 官方文档: https://docs.astral.sh/ruff/configuration/
# 规则列表: https://docs.astral.sh/ruff/rules/

# ========================================
# 基础设置
# ========================================
line-length = 120                  # 行长度（团队规范，超过需折行）
target-version = "py39"            # Python 版本（建议根据项目调整）
indent-width = 4                   # 缩进宽度（4个空格）

# 文件包含模式
include = ["*.py", "*.pyi", "*.ipynb"]

# 排除目录
exclude = [
  ".bzr",
  ".direnv",
  ".eggs",
  ".git",
  ".git-rewrite",
  ".hg",
  ".ipynb_checkpoints",
  ".mypy_cache",
  ".nox",
  ".pants.d",
  ".pyenv",
  ".pytest_cache",
  ".pytype",
  ".ruff_cache",
  ".svn",
  ".tox",
  ".venv",
  ".vscode",
  "__pypackages__",
  "_build",
  "buck-out",
  "build",
  "dist",
  "node_modules",
  "site-packages",
  "venv",
]

# 启用 preview 模式以获取最新功能
preview = true

[lint]
explicit-preview-rules = true
# ========================================
# 规则选择（基于公司 checklist）
# ========================================
# 策略：启用所有规则，选择性忽略不符合规范的规则
select = [
  "ALL",  # 启用所有规则
]

# ========================================
# 忽略规则（基于公司规范的例外）
# ========================================
ignore = [
  # ========== 与格式化工具冲突 ==========
  "E203",      # 空格在 slice 周围（与 Black 冲突）
  "E501",      # 行长度由 formatter 处理
  "ISC001",    # 单行隐式字符串连接（与格式化工具冲突）

  # ========== 团队特定：中文场景 ==========
  "RUF001",    # 字符串中的全角字符（中文需要）
  "RUF002",    # 文档字符串中的全角字符（中文需要）
  "RUF003",    # 注释中的全角字符（中文需要）

  # ========== 文档字符串（团队建议而非强制）==========
  "D100",      # 缺失模块文档字符串（建议添加）
  "D101",      # 缺失类文档字符串（建议添加）
  "D102",      # 缺失方法文档字符串（建议添加）
  "D103",      # 缺失函数文档字符串（建议添加）
  "D104",      # 缺失包文档字符串（建议添加）
  "D105",      # 缺失魔术方法文档字符串（可选）
  "D106",      # 缺失嵌套类文档字符串（可选）
  "D107",      # 缺失 __init__ 文档字符串（建议在类文档中说明）

  # ========== 文档字符串风格选择 ==========
  "D203",      # 与 D211 冲突，团队选择 D212（多行文档字符串从第一行开始）
  "D205",      # 文档字符串空行分隔（中文场景不需要）
  "D212",      # 多行文档字符串从第一行开始（团队选择 D213，第二行开始）
  "D415",      # 文档字符串第一行以标点结尾（中文场景不需要）

  # ========== 类型注解（团队建议而非强制）==========
  "ANN",       # 类型注解（团队建议使用，但未强制）

  # ========== 注释和 TODO（团队格式不统一）==========
  "TD002",     # TODO 作者格式要求
  "TD003",     # TODO 问题链接格式要求
  "FIX002",    # TODO 格式要求

  # ========== 团队习惯：安全和工具例外 ==========
  "S101",      # 使用 assert（用于内部正确性检查）
  "S324",      # hashlib 使用默认算法（团队有业务场景）
  "S603",      # subprocess 使用 shell=True（团队有业务场景）
  "S605",      # subprocess 启动进程（团队有业务场景）
  "S607",      # subprocess 启动进程（团队有业务场景）

  # ========== 可读性考虑 ==========
  "EM101",     # 异常中的原始字符串（团队认为 f-string 更清晰）
  "EM102",     # 异常中的 f-string
  "SIM108",    # 使用三元表达式（有时影响可读性）
]

# ========================================
# 自动修复配置
# ========================================
fixable = ["ALL"]
unfixable = []

# ========================================
# 每个文件的忽略规则
# ========================================
[lint.per-file-ignores]

# __init__.py 允许未使用的导入（用于导出）
"__init__.py" = [
  "F401",      # 允许未使用的导入
  "E402",      # 允许非顶层导入
]

# 测试文件的特殊规则
"test_*.py" = [
  "PLR2004",   # 测试中允许魔术常量
  "S101",      # 测试中允许 assert
  "ANN",       # 测试中不强制类型注解
  "D",         # 测试中不强制文档字符串
]

"tests/*.py" = [
  "PLR2004",   # 测试中允许魔术常量
  "ANN",       # 测试中不强制类型注解
  "D",         # 测试中不强制文档字符串
]

# Jupyter Notebook
"*.ipynb" = [
  "D",         # notebook 不强制文档字符串
  "E402",      # notebook 允许非顶层导入
  "I002",      # notebook 允许未排序的导入
]

# ========================================
# McCabe 复杂度设置
# ========================================
# 圈复杂度：10-15（简单），15-25（复杂需重构），>25（应拆分）
[lint.mccabe]
max-complexity = 15  # 复杂度阈值

# ========================================
# 格式化设置
# ========================================
[format]
quote-style = "double"           # 使用双引号
indent-style = "space"           # 使用空格缩进（4个空格）
line-ending = "auto"             # 自动检测行尾
skip-magic-trailing-comma = false  # 保留 magic trailing comma
docstring-code-format = true     # 格式化文档字符串中的代码
docstring-code-line-length = "dynamic"  # 文档字符串代码行长度动态调整

# ========================================
# isort 导入排序设置
# ========================================
# 导入顺序：__future__ -> 标准库 -> 第三方库 -> 第一方库 -> 本地库
[lint.isort]
known-first-party = ["src"]      # 第一方包（根据项目调整）
known-third-party = [
  "numpy",
  "pandas",
  "requests",
]                               # 常用第三方库（根据项目调整）
section-order = [
  "future",
  "standard-library",
  "third-party",
  "first-party",
  "local-folder",
]
combine-as-imports = true       # 合并 from x import a, b
split-on-trailing-comma = false  # 不在尾随逗号处分割
lines-after-imports = 2         # 导入后空两行

# ========================================
# pydocstyle 文档字符串设置
# ========================================
[lint.pydocstyle]
convention = "google"           # Google 风格（推荐，也可选 numpy/pep257）
ignore-decorators = ["property", "setter"]  # 忽略装饰器

# ========================================
# flake8-quotes 引号设置
# ========================================
[lint.flake8-quotes]
docstring-quotes = "double"      # 文档字符串使用双引号
inline-quotes = "double"         # 代码中统一使用双引号

# ========================================
# Pylint 设置（代码复杂度和质量）
# ========================================
[lint.pylint]
max-args = 7                    # 函数最大参数数量（checklist 要求 ≤8）
max-returns = 3                 # 函数最大返回值数量（checklist 强制要求）
max-statements = 50             # 函数最大语句数（checklist 要求）
max-branches = 12               # 最大分支数
max-locals = 15                 # 最大局部变量数
allow-magic-value-types = ["int", "float", "str"]  # 允许的魔术值类型

# ========================================
# flake8-bugbear 设置（框架支持）
# ========================================
[lint.flake8-bugbear]
extend-immutable-calls = [
  "fastapi.Depends",
  "fastapi.Query",
  "fastapi.Path",
  "fastapi.Body",
  "typer.Argument",
  "typer.Option",
]

# ========================================
# pyupgrade 设置（语法升级）
# ========================================
[lint.pyupgrade]
keep-runtime-typing = true  # 兼容旧版类型注解

# ========================================
# pycodestyle 设置（PEP 8）
# ========================================
[lint.pycodestyle]
max-line-length = 120       # pycodestyle 行长度（与全局一致）

# ========================================
# pep8-naming 命名约定（checklist 要求）
# ========================================
[lint.pep8-naming]
classmethod-decorators = [
  "classmethod",
  "pydantic.validator",
  "pydantic.field_validator",
  "staticmethod",
]
ignore-names = [               # 忽略测试函数命名
  "test_*",
  "setup_*",
  "teardown_*",
]

# ========================================
# flake8-type-checking 类型检查设置
# ========================================
[lint.flake8-type-checking]
strict = true                   # 严格模式
runtime-evaluated-base-classes = [
  "pydantic.BaseModel",
  "sqlalchemy.orm.DeclarativeBase",
]

# ========================================
# flake8-pytest-style 测试设置
# ========================================
[lint.flake8-pytest-style]
mark-parentheses = false        # 不强制 pytest.mark 使用括号

# ========================================
# 其他重要设置
# ========================================
# 注意: dummy-variable-rgx 已在 Ruff 新版本中移除，未使用变量默认警告

# ========================================
# 2025 最佳实践：使用建议
# ========================================
# 1. 安装：pip install ruff
# 2. 检查：ruff check .
# 3. 自动修复：ruff check --fix .
# 4. 格式化：ruff format .
# 5. 在 CI 中集成：ruff check --output-format=github
# 6. 与 pre-commit 集成
#
# 常用命令：
# - ruff check .              # 检查代码问题
# - ruff check --fix .        # 自动修复问题
# - ruff format .             # 格式化代码
# - ruff check --select E,F . # 只检查错误和语法
# - ruff check --select S .   # 只检查安全问题
#
# 参考资料：
# - 官方文档：https://docs.astral.sh/ruff/
# - 规则列表：https://docs.astral.sh/ruff/rules/
# - 配置参考：https://docs.astral.sh/ruff/settings/
#
# ========================================
# 公司 Checklist 对应的 Ruff 规则映射
# ========================================
# 01. style - 风格规范
#   - label (命名): N801-N818, UP024
#   - indent (缩进): W191, E101
#   - blank (空行): E301-E306
#   - wrap (折行): E501, E131, E129
#   - parenthesis (括号): E225
#   - space (空格): E221-E232, E241-E242, E271-E273
#   - trailing_comma: COM812, COM819
#   - coding_format: UP009, UP032
# 02. exception - 错误处理
#   - raise (异常抛出): TRY002, TRY003, TRY200, TRY201, TRY301
#   - catch (异常捕获): TRY401, BLE001
#   - exception (异常处理): TRY400, TRY401, TRY402, TRY403
#   - log (异常日志): TRY401
#   - assert (断言): F631, S101
# 03. func - 函数/方法
#   - default_parameter: B006, B008, R0133
#   - var_parameter: UP010
#   - parameter: UP020
#   - return: RET501-RET508
#   - properties: F841
#   - type_annotation: ANN001, ANN2xx, ANN4xx
#   - internal_fun: PLR0402
#   - lambda: E731, PLW0148
#   - decorator: UP027
# 04. language - 语言特性
#   - import: E401, I001-I002, I252, F401, F403, F405
#   - main: F401
#   - statement: E702-E704, E701
#   - if: E712, SIM102, SIM108, PLR5501
#   - comprehensions: C416-C419, C81x-C83x
#   - iterator: F832
#   - generator: F832
#   - cond_expression: SIM108
#   - bool: E711, E712, E713
#   - signletio_comparison: E711, E712, SIM300
#   - obsolete: UP024, UP031
#   - complex_feature: 不在 Ruff 范围（需要代码审查）
#   - string: UP032, UP034, ISC001, ISC003, S608, F632
#   - dict: F832, F841, PLC0206
#   - tuple: F621
#   - global: PLW0603, PLR1733
#   - init: E701
#   - list_remove: PLW2901
#   - performance: PERF401-403, PERF401
#   - object_comparison: E721, E711
#   - reusable_integers: F632
#   - magic: PLR2004
#   - resource: SIM115
#   - time: DTZ
#   - class_attr: PLW0123
#   - popen: S603-S607
#   - uuid: S108
#   - deserialize: S301, S501
# 05. concurrent - 并发
#   - thread_coroutine: RUF006, RUF010
#   - flush: 不在 Ruff 范围（需要代码审查）
# 06. i18n - 国际化
#   - 不在 Ruff 范围（需要专门的 i18n 工具）
# 07. security - 安全特性
#   - file_permissions: S103, S104, S105
#   - hardcoded: S105-S107
#   - tmp_directory: S108
#   - root_user: S102
#   - command_injection: S102, S307, S608
#   - weak_cryptographic: S311, S324, S505, S507, S508
#   - xml: S405
#   - ssl: S502, S503, S504
#   - sql_injection: S608
#   - frame: S201
#   - private_property: S101
# 08. third_party_library - 第三方库
#   - 不在 Ruff 范围（需要代码审查）
# 09. tools - 工具检查
#   - Ruff 本身就是工具检查工具
